// -------- 3D viewer with OrbitControls --------
(function initViewer() {
  const container = document.getElementById("viewer");

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf6f7fb);

  const width = container.clientWidth || 600;
  const height = container.clientHeight || 520;
  const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
  camera.position.set(50, 50, 400);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(width, height);
  container.innerHTML = "";
  container.appendChild(renderer.domElement);

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(5, 8, 5);
  scene.add(dir);

  // OrbitControls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Load model
  const loader = new THREE.GLTFLoader();
  loader.load("/static/model.glb", (gltf) => {
    const root = gltf.scene;
    root.scale.set(1, 1, 1);
    scene.add(root);

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  });
})();

// -------- Render JSON as table --------
function renderTable(containerId, data) {
  const container = document.getElementById(containerId);
  if (!Array.isArray(data)) {
    container.textContent = "No data available.";
    return;
  }
  if (data.length === 0) {
    container.textContent = "No rows.";
    return;
  }
  const table = document.createElement("table");
  table.border = "1";
  table.cellPadding = "6";

  // header
  const header = document.createElement("tr");
  Object.keys(data[0]).forEach((key) => {
    const th = document.createElement("th");
    th.textContent = key;
    header.appendChild(th);
  });
  table.appendChild(header);

  // rows
  data.forEach((row) => {
    const tr = document.createElement("tr");
    Object.values(row).forEach((val) => {
      const td = document.createElement("td");
      td.textContent = typeof val === "object" ? JSON.stringify(val) : val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });

  container.innerHTML = "";
  container.appendChild(table);
}

// -------- specs --------
async function loadSpecs() {
  try {
    const data = await getJSON("/api/specs");
    renderTable("specs", [data.product, data.electrical_specs, data.mechanical_specs, data.performance, data.construction]);
  } catch (e) {
    document.getElementById("specs").textContent = `Failed to load specs: ${e.message}`;
  }
}

// -------- sensors --------
async function loadSensors() {
  try {
    const data = await getJSON("/api/sensors");
    renderTable("sensors", data);
  } catch (e) {
    document.getElementById("sensors").textContent = `Failed to load sensors: ${e.message}`;
  }
}

loadSpecs();
loadSensors();
setInterval(loadSensors, 3000);
